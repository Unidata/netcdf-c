#!/bin/bash
# Script to automatically build, install netcdf-fortran.
# Very rought draft.

DOCMAKE=""
DOAUTOTOOL=""
DOACTION=""

MARG=""
if [ $# -lt 1 ]; then
    echo ""
    echo "WARNING! THIS SCRIPT IS NOT MEANT TO BE RUN MANUALLY."
    echo "WARNING! THIS SCRIPT IS NOT MEANT TO BE RUN MANUALLY."
    echo ""
    exit 1
fi

while getopts "a:t:" o; do
    case "${o}" in
        t)
            MARG=${OPTARG}
            ;;
        a)
            DOACTION=${OPTARG}
            ;;
        *)
            echo "Specify type with -t. Types are autotools or cmake."
            exit 1
            ;;
    esac
done


###
# Make sure we're specifying an allowed
# build system.
###
case ${MARG} in
    cmake)
        DOCMAKE="TRUE"
        ;;
    autotools)
        DOAUTOTOOL="TRUE"
        ;;
    *)
        echo "Illegal type. Types are autotools or cmake."
        exit 1
        ;;
esac

###
# Make sure we're performing a valid action.
###
case ${DOACTION} in
    build)
        ;;
    install)
        ;;
    *)
        echo "Illegal action."
        exit 1
        ;;
esac


###
# Fetch netcdf-fortran from git if need be.
###

if [ ! -d "netcdf-fortran" ]; then
    git clone http://github.com/unidata/netcdf-fortran
fi

cd netcdf-fortran
#git checkout v4.4.1

###
# Invoke cmake to build netcdf-fortran
###

if [ "x$DOCMAKE" = "xTRUE" ]; then

    mkdir -p build
    cd build

    if [ "x$DOACTION" = "xbuild" ]; then
        cmake .. -DCMAKE_PREFIX_PATH=@CMAKE_INSTALL_PREFIX@ -DCMAKE_INSTALL_PREFIX=@CMAKE_INSTALL_PREFIX@ -DBUILD_SHARED_LIBS=@BUILD_SHARED_LIBS@ -DTEST_PARALLEL=@ENABLE_PARALLEL@ &&
        make && make test
    fi

    if [ "x$DOACTION" = "xinstall" ]; then
        make install
    fi

fi

if [ "x$DOAUTOTOOL" = "xTRUE" ]; then

    if [ "x$DOACTION" = "xbuild" ]; then
        CFLAGS="-I@abs_top_builddir@/include" LDFLAGS="-L@abs_top_builddir@/liblib/.libs" ./configure --prefix=@prefix@
        make && make check
    fi

    if [ "x$DOACTION" = "xinstall" ]; then
        make install
    fi

fi
