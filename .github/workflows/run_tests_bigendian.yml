###
# Build and test netCDF-C on a big-endian platform (s390x) using QEMU emulation.
###

name: Run Big-Endian (s390x) netCDF Tests

on: [workflow_dispatch]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:

  nc-bigendian-s390x:

    name: Autotools build on s390x (big-endian)
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4

      - name: Add swap space
        run: |
          sudo swapoff -a || true
          sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Build and test on s390x via QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: s390x
          distro: ubuntu22.04

          # Pass the checked-out source into the container
          githubToken: ${{ github.token }}

          install: |
            apt-get update -q -y
            apt-cache search libhdf5 | sort
            apt-get install -q -y \
              libaec-dev \
              zlib1g-dev \
              automake \
              autoconf \
              libcurl4-openssl-dev \
              libjpeg-dev \
              wget \
              curl \
              bzip2 \
              m4 \
              flex \
              bison \
              cmake \
              libzip-dev \
              libhdf5-dev \
              libhdf5-103-1 \
              libtool \
              gcc \
              g++

          run: |
            set -e
            set -x

            ###
            # Configure and build netCDF-C against apt-installed HDF5
            ###
            autoreconf -if

            CPPFLAGS="-I/usr/include/hdf5/serial" \
            LDFLAGS="-L/usr/lib/s390x-linux-gnu/hdf5/serial" \
            LIBS="-lhdf5_serial -lz" \
            CC=gcc \
            ./configure \
              --enable-hdf5 \
              --disable-dap \
              --disable-dap-remote-tests \
              --disable-nczarr \
              --disable-libxml2 \
              --disable-shared \
              --enable-static \
              --disable-utilities \
              || { tail -200 config.log; exit 1; }

            cat libnetcdf.settings

            make -j 1

            ###
            # Build and run tests
            ###
            make check TESTS="" -j 1
            make check -j 1

      - name: Show config.log on failure
        if: ${{ failure() }}
        run: cat config.log || true
