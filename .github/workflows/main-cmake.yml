name: NetCDF-C CMake CI - Windows

on: [ pull_request, workflow_dispatch]

env:
  REMOTETESTDOWN: ${{ vars.REMOTETESTDOWN }}

concurrency:  
  group: ${{ github.workflow }}-${{ github.head_ref }}  
  cancel-in-progress: true
  
jobs:

  cmake_build_and_test:
    strategy:
      
        matrix:
            name: 
                - "Windows MSVC"
            hdf5:
                - "1.14.3"

            # Visual Studio + CMake
            include:
                - name: "Windows MSVC"
                  os: windows-latest
                  generator: "-G  \"Visual Studio 17 2022\""

    name: "${{ matrix.name }}"
        
    runs-on: ${{ matrix.os }}

    # Each step in the job.
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    steps:
        - uses: msys2/setup-msys2@v2
          with:
            update: true
        - uses: actions/checkout@v4
        - uses: conda-incubator/setup-miniconda@v3
          with:
            miniconda-version: "latest"
            activate-environment: ""
            auto-activate-base: true

        - name: Set up Paths and env
          shell: bash -el {0}
          run: |
            echo "" >> ~/.bash_profile
            cat ~/.bash_profile


        - name: Dump Matrix Context
          run: echo '${{ toJSON(matrix) }}'

        #- run: echo "CMAKE_PREFIX_PATH=${env.CONDA_PREFIX}/Library" >> $GITHUB_ENV
        #- run: echo "/c/Users/runneradmin/miniconda3/Library/lib:${GITHUB_PATH}" >> $GITHUB_ENV
        #- run: echo ""
        #- run: echo "CTEST_OUTPUT_ON_FAILURE=1" >> $GITHUB_ENV
       
        # Grab miniconda and use it to install HDF5
        - name: Install Dependencies using Miniconda
          run: |
            conda config --set always_yes yes --set changeps1 no --set show_channel_urls true
            conda config --add channels conda-forge
            conda update conda
            conda install hdf5=${{ matrix.hdf5 }} m2-m4 libxml2
          shell: bash -el {0}

        # Double-check something
        - name: Check Miniconda
          run: |
            which h5dump
            which m4
          shell: bash -el {0}
     
        # Check current directory
        - name: Query Current Environment
          run: |
            ls 
            echo ""
            echo "PATH: $PATH"
            echo ""
            env
            echo ""
            ls $CONDA_PREFIX/Library
            echo ""
            ls $CONDA_PREFIX/Library/include/
          shell: bash -el {0}

        - name: Perform out-of-directory configuration
          shell: bash -el {0}
          run: |
            mkdir build
            cd build
            cmake .. -DCMAKE_PREFIX_PATH="${CONDA_PREFIX}/Library" -DCMAKE_C_FLAGS="-I${CONDA_PREFIX}/Library/include" -DCMAKE_INSTALL_PREFIX=~/tmp -DNETCDF_ENABLE_FILTER_TESTING=OFF
          if: ${{ success() }}

        - name: View cache - configuration
          shell: bash -el {0}
          run: |
            cd build
            cmake -L .
          if: ${{ success() }}

        - name: Print Summary
          shell: bash -el {0}
          run: |
            cd build
            cat libnetcdf.settings  

        - name: Perform out-of-directory build - libnetcdf
          shell: bash -el {0}
          run: |
            cd build
            cmake --build . --config Release --target netcdf -j 4

        - name: Perform out-of-directory install - libnetcdf
          shell: bash -el {0}
          run: |
            cd build
            cmake --build . --config Release --target install -j 4
          continue-on-error: true

        - name: View config.h - libnetcdf failure
          shell: bash -el {0}
          run: |
            cd build
            cat config.h
          if: ${{ failure() }}

        - name: Perform out-of-directory build - test suite
          id: build_tests
          shell: bash -el {0}
          run: | 
            cd build
            cmake --build . --config Release -j 4
      
        - name: View config.h - tests failure failure
          shell: bash -el {0}
          run: |
            cd build
            cat config.h
          if: ${{ failure() }}  

        - name: Debug - find all netcdf and hdf5 DLLs
          if: always()
          shell: powershell
          run: |
            Write-Host "=== CONDA env var ==="
            Write-Host "CONDA = $env:CONDA"
            Write-Host ""
            Write-Host "=== USERPROFILE env var ==="
            Write-Host "USERPROFILE = $env:USERPROFILE"
            Write-Host ""
            Write-Host "=== Find netcdf.dll anywhere under USERPROFILE ==="
            Get-ChildItem -Path $env:USERPROFILE -Recurse -Filter "netcdf.dll" -ErrorAction SilentlyContinue | Select-Object FullName, Length
            Write-Host ""
            Write-Host "=== Find hdf5.dll anywhere under CONDA ==="
            Get-ChildItem -Path "$env:CONDA\Library" -Recurse -Filter "hdf5.dll" -ErrorAction SilentlyContinue | Select-Object FullName, Length
            Write-Host ""
            Write-Host "=== Contents of install bin dir ==="
            Get-ChildItem "$env:USERPROFILE\tmp\bin" -ErrorAction SilentlyContinue | Select-Object Name, Length
            Write-Host ""
            Write-Host "=== Contents of install lib dir ==="
            Get-ChildItem "$env:USERPROFILE\tmp\lib" -ErrorAction SilentlyContinue | Select-Object Name, Length
            Write-Host ""
            Write-Host "=== Find netcdf.dll in build tree ==="
            Get-ChildItem -Path "D:\a\netcdf-c\netcdf-c\build" -Recurse -Filter "netcdf.dll" -ErrorAction SilentlyContinue | Select-Object FullName, Length
            Write-Host ""
            Write-Host "=== Check what ~ resolves to in bash ==="

        - name: Debug - check bash tilde and HOME
          if: always()
          shell: bash -el {0}
          run: |
            echo "HOME=$HOME"
            echo "USERPROFILE=$USERPROFILE"
            echo "tilde expands to: $(echo ~)"
            echo "ls ~/tmp/bin:"
            ls -la ~/tmp/bin/ 2>&1 || echo "~/tmp/bin does not exist"
            echo "ls ~/tmp/lib:"
            ls -la ~/tmp/lib/ 2>&1 || echo "~/tmp/lib does not exist"
            echo ""
            echo "=== CMAKE_INSTALL_PREFIX from cache ==="
            grep CMAKE_INSTALL_PREFIX build/CMakeCache.txt || true
            echo ""
            echo "=== find netcdf.dll in build ==="
            find build -name "netcdf.dll" 2>/dev/null || echo "not found in build"
            echo ""
            echo "=== find netcdf.dll under HOME ==="
            find "$HOME" -name "netcdf.dll" 2>/dev/null || echo "not found under HOME"

        - name: Add DLL directories to PATH
          if: always()
          shell: powershell
          run: |
            # Add conda Library/bin for hdf5.dll etc
            $condaBin = "$env:CONDA\Library\bin"
            Write-Host "Adding to PATH: $condaBin"
            $condaBin | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
            # Add install bin for netcdf.dll
            $installBin = "$env:USERPROFILE\tmp\bin"
            Write-Host "Adding to PATH: $installBin"
            $installBin | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
            # Also add the build liblib directory where netcdf.dll might be
            $buildLib = "D:\a\netcdf-c\netcdf-c\build\liblib\Release"
            Write-Host "Adding to PATH: $buildLib"
            $buildLib | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
            # Show what we wrote
            Write-Host ""
            Write-Host "=== GITHUB_PATH contents ==="
            Get-Content $env:GITHUB_PATH

        - name: Verify PATH after update
          if: always()
          shell: powershell
          run: |
            Write-Host "=== Full PATH ==="
            $env:PATH -split ';' | ForEach-Object { Write-Host $_ }
            Write-Host ""
            Write-Host "=== where.exe hdf5.dll ==="
            & where.exe hdf5.dll 2>&1
            Write-Host ""
            Write-Host "=== where.exe netcdf.dll ==="
            & where.exe netcdf.dll 2>&1
            Write-Host ""
            Write-Host "=== Try running a test exe directly ==="
            $testExe = Get-ChildItem -Path "D:\a\netcdf-c\netcdf-c\build\nc_test4" -Filter "nc_test4_tst_put_vars.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($testExe) {
              Write-Host "Found test exe: $($testExe.FullName)"
              & $testExe.FullName 2>&1
              Write-Host "Exit code: $LASTEXITCODE"
            } else {
              Write-Host "Test exe not found, listing nc_test4 dir:"
              Get-ChildItem "D:\a\netcdf-c\netcdf-c\build\nc_test4" -ErrorAction SilentlyContinue | Select-Object Name
            }

        - name: Run ctest
          if: ${{ steps.build_tests.outcome == 'success' }}
          shell: powershell
          run: |
            cd build
            ctest . -j 4 -E "bom|run_|tst_ncdap|dap4_test_test_|do_comps" --output-on-failure
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
            
        - name: Verbose Output if CTest Failure
          shell: powershell
          run: |
            cd build
            ctest . --rerun-failed --output-on-failure -VV
          if: ${{ failure() }}    
