###
# Using Conda for dependencies, build and run NetCDF tests
# using cmake + Visual Studio
###

name: Run Visual-Studio based tests using MSYS2 and micromamba

on: [push,workflow_dispatch]

concurrency:  
  group: ${{ github.workflow}}-${{ github.head_ref }}  
  cancel-in-progress: true

jobs:

    install-dependencies:

        runs-on: windows-latest
        defaults:
            run:
                shell: msys2 {0}

        steps:
            - uses: actions/checkout@v3
            - uses: mamba-org/setup-micromamba@v1
              with:
                environment-name: CI
            - uses: msys2/setup-msys2@v2
              with:
                msystem: MINGW64
                update: true
                install: unzip automake libtool autoconf make m4

            - name: Install Micromamba dependencies
              shell: bash -l {0}
              run: micromamba install --quiet --yes hdf5 zlib cmake

            - name: (Query Environment)
              run: ls && env && echo "" && pwd && echo "" && which m4

            - name: CMake (Generate)
              shell: bash -l {0}
              run: >
                mkdir build &&
                cd build &&
                cmake .. -DENABLE_FILTER_TESTING=OFF
                

                